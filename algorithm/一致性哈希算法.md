# 一致性哈希算法 

----------------------------------------------------

​	提到一致性哈希则不得不提传统哈希表，而传统哈希表有什么弊端呢？

​		*下面通过一个实际应用场景，我们来快速了解一下传统hash表的弊端。*

​	或许你听说过`负载均衡`技术，不明白的可以看 [这里](https://juejin.im/entry/5aeb158f518825672033e90f)。在此基础上，如何实现一个`会话粘滞（session sticky）`的负载均衡算法呢？也就是说，我们需要在同一个客户端上，在一次会话中的所有请求都路由到同一个服务器上。

- 最直接的方法就是，维护一张映射关系表，这张表的内容是客户端 IP 地址或者会话 ID 与服务器编号的映射关系。
  - 如果客户端很多，映射表可能会很大，比较浪费内存空间；
  - 客户端下线、上线，服务器扩容、缩容都会导致映射失效，这样维护映射表的成本就会很大；
- 我们可以通过哈希算法，对客户端 IP 地址或者会话 ID 计算哈希值，将取得的哈希值与服务器列表的大小进行取模运算，最终得到的值就是应该被路由到的服务器编号。 这样，我们就可以把同一个 IP 过来的所有请求，都路由到同一个后端服务器上。

​	若集群又扛不住了，此时需要再加一台机器怎么办？注意，此时不是简单加一台机器就行了，因为此时内存中已经有原来的hash值了，如果直接新加机器会导致内存中的hash值不可以用，即`缓存穿透`，引发雪崩效应，压跨数据库。

此时，我们就需要`一致性哈希算法`了。

**一致性哈希算法的基本思想**

> 假设我们有 k 个机器，数据的哈希值的范围是 [0, MAX]。我们将整个范围划分成 m 个小区间（m 远大于 k），每个机器负责 m/k 个小区间。当有新机器加入的时候，我们就将某几个小区间的数据，从原来的机器中搬移到新的机器中。这样，既不用全部重新哈希、搬移数据，也保持了各个机器上数据数量的均衡。

